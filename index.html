<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' 'unsafe-inline';
               style-src 'self' 'unsafe-inline'">
<title>ğŸ² ë³´ê²œë™</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ê¸°ì¡´ CSS ê·¸ëŒ€ë¡œ ìœ ì§€ */
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#0b0e11;color:#eaecef;scroll-behavior:smooth;}

header{
  background:#161a1e;
  padding:16px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:26px;
  font-weight:700;
  box-shadow:0 4px 14px rgba(0,0,0,0.5);
  position:relative;
  z-index:10;
  cursor:pointer;
}
header .logo{cursor:pointer;}
header .points{font-size:16px;font-weight:600;color:#f0b90b;}
#adminBtn{
  position:fixed;
  right:16px;
  bottom:16px;

  padding:14px 18px;
  border-radius:50%;
  background:#f0b90b;
  border:none;

  font-weight:700;
  cursor:pointer;

  box-shadow:0 8px 20px rgba(0,0,0,0.5);
  z-index:999;
}

/* ì»¨í…Œì´ë„ˆ */
.container{max-width:1200px;margin:20px auto;padding:0 10px;display:flex;flex-direction:column;gap:8px;} 

/* ê²½ê¸° ëª©ë¡ ì¹´ë“œ */
.matchList{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
.matchCard{
  padding:12px 16px;
  background:#1f2329;
  border-radius:16px;
  color:#f0b90b;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);
}
.matchCard:hover{background:#292d33;}
.matchName{font-weight:600;font-size:16px;}
.matchTime{font-size:14px;color:#eaecef;}

/* ì¹´ë“œ */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;position:relative;}

.player{
  background: rgba(28,31,36,0.55);
  backdrop-filter: blur(12px);
  border-radius:28px;padding:14px;
  cursor:pointer;
  transition: height 0.2s ease, box-shadow 0.2s ease,border 0.2s ease;
  box-shadow:0 6px 18px rgba(0,0,0,0.5);
  position:relative;height:110px;overflow:hidden;
  border:2px solid transparent;
  display:flex;flex-direction:column;
}
.player.active{height:190px;} 
.player.checked{border-color:#f0b90b;} 

.player .topRow{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:11.45px;
}
.player .checkCircle{
  width:24px;height:24px;border-radius:50%;border:2px solid #f0b90b;
  background:rgba(0,0,0,0.3);cursor:pointer;transition:all 0.2s ease;
}
.player .checkCircle.checked{background:#f0b90b;transform:scale(1.2);}

.player h3{font-size:16px;font-weight:600;text-align:left;margin:0;}
.player .row{display:flex;justify-content:space-between;font-size:14px;margin-top:2px;}
.player .odds{font-size:16px;font-weight:700;color:#f0b90b;}

.detailPanel{
  background: rgba(22,26,30,0.65);
  backdrop-filter: blur(12px);
  border-radius:24px;
  padding:10px;
  margin-top:4px;
  box-shadow:0 6px 16px rgba(0,0,0,0.5);
  display:none;
}

/* ë² íŒ… ì˜ì—­ */
#betAreaGlobal{
  display:none; 
  justify-content:space-between;
  align-items:center;
  max-width:360px;
  margin:4px auto 0 auto;
}
#betAreaGlobal input,
#betAreaGlobal button{
  height:42px; /* ë†’ì´ ë§ì¶¤ */
  font-size:16px;
  border-radius:18px;
  padding:0 12px;
  border:none;
}
#betAreaGlobal input{flex:1;background: rgba(28,31,36,0.6);color:#eaecef;}
#betAreaGlobal button{background:#f0b90b;color:#000000;font-weight:700;cursor:pointer;transition:all 0.2s ease;}
#betAreaGlobal button:hover{background:#e0a800;}

@media(max-width:900px){
  .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));margin-bottom:30px;}
  #betAreaGlobal{max-width:90%;flex-direction:row;gap:6px;}
}
</style>
</head>
<body>

<header>
  <div class="logo" onclick="goHome()">ğŸ² ë³´ê²œë™</div>
  <div class="points" id="pointDisplay">BGD: 1000</div>
</header>

<button id="adminBtn">ê´€ë¦¬ì</button>

<div class="container">

  <!-- ê²½ê¸° ëª©ë¡ -->
  <div class="matchList" id="matchList"></div>

  <!-- ì¹´ë“œ ì˜ì—­ -->
  <div class="grid" id="players"></div>

  <!-- ë² íŒ… ì˜ì—­ -->
  <div id="betAreaGlobal">
    <input type="number" id="betAmountGlobal" placeholder="ë² íŒ… BGD">
    <button onclick="placeBetGlobal()">ë² íŒ… í™•ì •</button>
  </div>
</div>

<script>
function escapeHTML(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

// =========================
// ê¸°ì¡´ ì„¤ì •/ë³€ìˆ˜
// =========================
const baseAvg=1.75, alpha=0.75, minOdds=0.6, maxOdds=3.0, k=5;
const API = "https://patient-darkness-ff6b.the1stdicks.workers.dev";

let myPoints = 0;
let userId = localStorage.getItem("userId");
let sessionToken = localStorage.getItem("sessionToken");

let playersData={
  "Match 1":[{name:"A",scores:[],avg:0},{name:"B",scores:[],avg:0},{name:"C",scores:[],avg:0},{name:"D",scores:[],avg:0}],
  "Match 2":[{name:"E",scores:[],avg:0},{name:"F",scores:[],avg:0},{name:"G",scores:[],avg:0},{name:"H",scores:[],avg:0}]
};

let matchesInfo=[
  {id:"Match 1", time:"2026-01-28 18:00", players:["A","B","C","D"]},
  {id:"Match 2", time:"2026-01-28 20:00", players:["E","F","G","H"]}
];

let currentPlayers=[];
let checkedPlayer=null;
let selectedMatch=null;

// =========================
// í‰ê· /ë°°ë‹¹ ê³„ì‚°
// =========================
function calcAvg(p){let n=p.scores.length;if(n===0)return baseAvg;let s=p.scores.reduce((a,b)=>a+b,0);return ((n/(n+k))*(s/n)+(k/(n+k))*baseAvg);}
function calcOdds(avg){let o=alpha*((baseAvg/avg)-1)+1;return Math.min(maxOdds,Math.max(minOdds,o)).toFixed(2);}

// =========================
// í™ˆ/ë¦¬ìŠ¤íŠ¸/ì¹´ë“œ ë Œë”
// =========================
function goHome(){
  currentPlayers=[];
  selectedMatch=null;
  document.getElementById("players").innerHTML="";
  document.getElementById("betAreaGlobal").style.display="none";
}

function renderMatchList(){
  const container=document.getElementById("matchList");
  container.innerHTML="";
  matchesInfo.forEach(m=>{
    const div=document.createElement("div"); div.className="matchCard";
    div.innerHTML = `
  <div class="matchName">
    ${m.players.map(escapeHTML).join(", ")}
  </div>
  <div class="matchTime">${escapeHTML(m.time)}</div>
`;
    div.onclick=()=>toggleMatch(m.id);
    container.appendChild(div);
  });
}

function toggleMatch(matchId){
  if(selectedMatch===matchId){ goHome(); } 
  else{
    selectedMatch=matchId;
    currentPlayers=JSON.parse(JSON.stringify(playersData[matchId]));
    renderPlayers();
    document.getElementById("betAreaGlobal").style.display="flex";
  }
}

function renderPlayers(){
  const container=document.getElementById("players"); container.innerHTML="";
  currentPlayers.forEach(p=>{
    p.avg=calcAvg(p);
    const odds=calcOdds(p.avg);
    const div=document.createElement("div"); div.className="player";
    div.innerHTML=`
      <div class="topRow">
        <h3>${escapeHTML(p.name)}</h3>
        <div class="checkCircle"
     data-name="${escapeHTML(p.name)}"
     onclick="toggleCheck(event,'${escapeHTML(p.name)}')"></div>
      <div class="row"><div>í‰ê·  ë“ì </div><div>${p.avg.toFixed(2)}</div></div>
      <div class="row"><div>ë°°ë‹¹</div><div class="odds">${odds}</div></div>
      <div class="detailPanel" id="detail-${p.name}">
        <div>ì´ì : ${p.scores.reduce((a,b)=>a+b,0)}</div>
        <div>ìµœê·¼ ê²½ê¸° ê¸°ë¡: ${p.scores.map(v => escapeHTML(v)).join(", ")}</div>
      </div>
    `;
    div.onclick=()=>toggleDetail(p.name);
    container.appendChild(div);
  });
}

function toggleDetail(name){
  const panel=document.getElementById(`detail-${name}`);
  const card=document.querySelector(`#detail-${name}`).parentElement;
  if(panel.style.display==="block"){
    panel.style.display="none";
    card.classList.remove("active");
  }else{
    panel.style.display="block";
    card.classList.add("active");
  }
}

function toggleCheck(e,name){
  e.stopPropagation();
  const allCircles=document.querySelectorAll(".checkCircle");
  const allCards=document.querySelectorAll(".player");
  allCircles.forEach(c=>{if(c.dataset.name!==name) c.classList.remove("checked");});
  allCards.forEach(c=>{if(c.querySelector(".checkCircle").dataset.name!==name) c.classList.remove("checked");});
  const circle=e.target;
  circle.classList.toggle("checked");
  const card=circle.parentElement.parentElement;
  if(circle.classList.contains("checked")){ card.classList.add("checked"); checkedPlayer=name; } 
  else { card.classList.remove("checked"); checkedPlayer=null; }
}

// =========================
// ê³µìš© ë² íŒ… ì ìš©
// =========================
async function placeBetGlobal(){
  const amt = Number(document.getElementById("betAmountGlobal").value);
  if(!amt || amt<=0){ alert("ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  if(!checkedPlayer){ alert("í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

  const res = await fetch(`${API}/bet`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Session-Token": sessionToken
    },
    body: JSON.stringify({
      matchId: selectedMatch,
      player: checkedPlayer,
      amount: amt
    })
  });

  const data = await res.json();

  if(!res.ok){
    alert(data.error || "ë² íŒ… ì‹¤íŒ¨");
    return;
  }

  myPoints = data.balance;
  document.getElementById("pointDisplay").innerText = `BGD: ${myPoints}`;

  alert(`${checkedPlayer}ì—ê²Œ ${amt} BGD ë² íŒ… ì™„ë£Œ!`);

  document.getElementById("betAmountGlobal").value="";
  document.querySelectorAll(".checkCircle").forEach(el=>el.classList.remove("checked"));
  document.querySelectorAll(".player").forEach(card=>card.classList.remove("checked"));
  checkedPlayer=null;
}

// =========================
// ê´€ë¦¬ì ë²„íŠ¼ (ì¡°íšŒ / ì´ˆê¸°í™” ê²¸ìš©)
// =========================
document.getElementById("adminBtn").onclick = async () => {
  const key = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸");
  if (!key) return;

  const mode = prompt("1: ë² íŒ… ì¡°íšŒ\n2: ì „ì²´ ì´ˆê¸°í™”");
  if (!mode) return;

  // ğŸ“Š ë² íŒ… ì¡°íšŒ
  if (mode === "1") {
    const matchId = prompt("ì¡°íšŒí•  Match ID (ì˜ˆ: Match 1)");
    if (!matchId) return;

    const res = await fetch(
      `https://patient-darkness-ff6b.the1stdicks.workers.dev/admin/bets?matchId=${encodeURIComponent(matchId)}`,
      {
        headers: {
          "X-Admin-Key": key
        }
      }
    );

    const data = await res.json();
    if (!res.ok) {
      alert("ì¡°íšŒ ì‹¤íŒ¨");
      return;
    }

    console.table(data.bets);
    alert("ê°œë°œìë„êµ¬(F12) â†’ Consoleì—ì„œ ë² íŒ… ë‚´ì—­ í™•ì¸");
  }

  // ğŸ”´ ì „ì²´ ì´ˆê¸°í™”
  if (mode === "2") {
    const res = await fetch(
      "https://patient-darkness-ff6b.the1stdicks.workers.dev/admin/reset",
      {
        method: "POST",
        headers: {
          "X-Admin-Key": key
        }
      }
    );

    const data = await res.json();
    if (res.ok && data.ok) {
      alert("ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ");
    } else {
      alert("ì´ˆê¸°í™” ì‹¤íŒ¨");
    }
  }
};

// =========================
// ğŸ”¥ ê´€ë¦¬ì ì „ì²´ ì´ˆê¸°í™” ê°ì§€ (ì™„ì „ ë¦¬ì…‹)
// =========================
async function checkReset() {
  try {
    const res = await fetch("https://patient-darkness-ff6b.the1stdicks.workers.dev/reset-status");
    if (!res.ok) return;

    const data = await res.json();
    const serverTs = data.resetTs || "0";
    const localTs = localStorage.getItem("lastReset") || "0";

    if (serverTs !== localTs) {
      // ğŸ”¥ ì™„ì „ ì´ˆê¸°í™”
      localStorage.clear();
      localStorage.setItem("lastReset", serverTs);

      alert("ê´€ë¦¬ìê°€ ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.");
      location.reload();
    }
  } catch (err) {
    console.error("reset check failed", err);
  }
}

setInterval(checkReset, 3000);
checkReset();

async function initSession() {
  const res = await fetch(`${API}/session`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId })
  });

  const data = await res.json();

  userId = data.userId;
  sessionToken = data.token;

  localStorage.setItem("userId", userId);
  localStorage.setItem("sessionToken", sessionToken);

  await updateBalanceFromServer();
}

async function updateBalanceFromServer() {
  const res = await fetch(`${API}/balance`, {
    headers: {
      "X-Session-Token": sessionToken
    }
  });

  const data = await res.json();
  myPoints = data.balance;
  document.getElementById("pointDisplay").innerText = `BGD: ${myPoints}`;
}

// =========================
// ì´ˆê¸° ê²½ê¸° ëª©ë¡ ë Œë”
// =========================
initSession().then(renderMatchList);
</script>
</body>
</html>





